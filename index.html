<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookAI - Uso Local e Pessoal (Final Corrigido)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* [IN√çCIO DO CSS] */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        #app-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header { display: flex; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #ddd; margin-bottom: 30px; }
        #logo { width: 50px; height: 50px; margin-right: 15px; border-radius: 5px; object-fit: cover; }
        h1 { color: #2c3e50; font-size: 1.8em; margin: 0; }
        #main-page { text-align: center; padding-top: 50px; }
        #main-page h2 { font-size: 2.5em; margin-bottom: 40px; color: #34495e; }
        #prompt-input { width: 80%; max-width: 600px; padding: 15px 20px; font-size: 1.2em; border: 2px solid #ccc; border-radius: 30px; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #prompt-input:focus { border-color: #3498db; box-shadow: 0 6px 10px rgba(52, 152, 219, 0.2); outline: none; }
        #config-page { display: grid; grid-template-columns: 1fr; gap: 30px; } 
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        #synopsis-box { grid-column: 1 / 2; } 
        #synopsis-text { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; resize: vertical; font-size: 1em; }
        #generate-button { grid-column: 1 / 2; padding: 15px 30px; background-color: #2ecc71; color: white; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; transition: background-color 0.3s; }
        #generate-button:hover { background-color: #27ae60; }
        #loading-message { grid-column: 1 / 2; text-align: center; font-size: 1.2em; color: #f39c12; margin-top: 20px; display: none; }
        #download-link { grid-column: 1 / 2; text-align: center; margin-top: 30px; display: none; }
        #download-link a { padding: 15px 30px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5-px; font-size: 1.2em; display: inline-block; transition: background-color 0.3s; }
        #download-link a:hover { background-color: #2980b9; }
        #pdf-content-area { position: absolute; left: -9999px; width: 700px; padding: 50px; background-color: white; }
        .book-page { width: 700px; height: 990px; padding: 50px; box-sizing: border-box; font-size: 12pt; line-height: 1.6; page-break-after: always; }
        .cover-page { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 990px; background-color: #2c3e50; color: white; page-break-after: always; }
        .cover-image { width: 400px; height: 550px; margin-bottom: 30px; object-fit: cover; border: 5px solid #ecf0f1; background-color: #34495e; }

        /* Estilos do Modal (Visualiza√ß√£o/Edi√ß√£o) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 8px; }
        .modal-content h3 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-content textarea { width: 100%; height: 400px; padding: 10px; border: 1px solid #ccc; box-sizing: border-box; resize: vertical; font-size: 1em; font-family: monospace; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        #modal-actions { text-align: right; margin-top: 15px; }
        #modal-actions button { padding: 10px 20px; margin-left: 10px; cursor: pointer; border: none; border-radius: 5px; }
        #save-edit-btn { background-color: #2ecc71; color: white; }
        #cancel-edit-btn { background-color: #ccc; color: #333; }

        /* [FIM DO CSS] */
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <img id="logo" src="Logo.jpg" alt="Logo BookAI">
            <h1>BookAI</h1>
        </header>

        <div id="main-page" style="display: block;">
            <h2>O que voc√™ quer criar hoje? üìö‚ú®</h2>
            <input type="text" id="prompt-input" placeholder="Digite a ideia principal do seu livro (ex: Um detetive rob√¥ em um mundo dist√≥pico de 2077)..." onkeyup="checkEnter(event)">
        </div>

        <div id="config-page" style="display: none;">
            <div class="column-left">
                <h2>Detalhes e Formato do Ebook ‚úèÔ∏è</h2>
                <div class="input-group">
                    <label for="title-input">T√≠tulo do Livro:</label>
                    <input type="text" id="title-input" value="Meu Grande Ebook">
                </div>
                <div class="input-group">
                    <label for="author-input">Nome do Autor:</label>
                    <input type="text" id="author-input" placeholder="Seu Nome">
                </div>
                <div class="input-group">
                    <label for="pages-select">Quantidade de P√°ginas (Conte√∫do):</label>
                    <select id="pages-select">
                        <script>
                            for (let i = 1; i <= 20; i++) {
                                document.write(`<option value="${i}" ${i === 5 ? 'selected' : ''}>${i} p√°ginas</option>`);
                            }
                        </script>
                    </select>
                </div>
                <div class="input-group">
                    <label for="genre-input">G√™nero/Estilo (Opcional):</label>
                    <input type="text" id="genre-input" placeholder="Fic√ß√£o Cient√≠fica, Romance, etc.">
                </div>
                <div class="input-group">
                    <label for="font-size-select">Tamanho da Fonte:</label>
                    <select id="font-size-select">
                        <option value="10">Pequena (10pt)</option>
                        <option value="12" selected>Normal (12pt)</option>
                        <option value="14">Grande (14pt)</option>
                    </select>
                </div>
            </div>

            <div id="synopsis-box">
                <label for="synopsis-text">Sinopse do Livro (Edit√°vel):</label>
                <textarea id="synopsis-text"></textarea>
            </div>
            
            <button id="generate-button" onclick="callGeminiAndOpenEditor()">Gerar Rascunho e Visualizar Edi√ß√£o</button>
            <p id="loading-message">‚è≥ Chamando a API Gemini...</p>
            <div id="download-link">
                <a href="#" id="pdf-download" download="BookAI_Ebook.pdf">‚¨áÔ∏è Baixar Livro em PDF</a>
            </div>
        </div>
    </div>

    <div id="pdf-content-area"></div>

    <div id="editorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Revisar e Editar Rascunho do Livro</h3>
            <p><strong>Prompt da Capa Sugerido:</strong> <span id="capa-prompt-display" style="font-weight: normal;"></span></p>
            <textarea id="book-content-editor"></textarea>
            <div id="modal-actions">
                <button id="cancel-edit-btn" onclick="closeModal()">Cancelar e Voltar</button>
                <button id="save-edit-btn" onclick="generatePdfFromEditor()">‚úÖ Gerar PDF a partir deste Conte√∫do</button>
            </div>
        </div>
    </div>


    <script>
        // üö® RISCO DE SEGURAN√áA: CHAVE INSERIDA AQUI! üö®
        const API_KEY = 'AIzaSyAL0y06n7XJfv4TAxoecRf16cwm7BAKi7w'; 
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

        let lastGeneratedCapaPrompt = "";
        let lastGeneratedBookContent = "";

        // --- Fun√ß√µes de Navega√ß√£o e Auxiliares ---

        function cleanTitle(synopsis) {
            // Remove frases repetitivas do in√≠cio da sinopse para limpar o t√≠tulo
            const clean = synopsis.replace(/(o\s+livro\s+sobre|um\s+ebook\s+sobre|o\s+livro\s+de)/i, '').trim();
            const words = clean.split(' ');
            // Pega as 5 primeiras palavras para um t√≠tulo limpo
            return words.slice(0, 5).join(' ') + (words.length > 5 ? '...' : ''); 
        }

        function goToConfig(synopsis) {
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('config-page').style.display = 'grid';
            document.getElementById('synopsis-text').value = synopsis;
            const currentTitle = document.getElementById('title-input').value;
            // Atualiza o t√≠tulo apenas se for o valor padr√£o ou o valor anterior gerado
            if (currentTitle === 'Meu Grande Ebook' || currentTitle.startsWith('O Livro de')) {
                document.getElementById('title-input').value = cleanTitle(synopsis);
            }
        }

        function checkEnter(event) {
            if (event.key === 'Enter') {
                const prompt = document.getElementById('prompt-input').value.trim();
                if (prompt) {
                    goToConfig(prompt);
                } else {
                    alert("Por favor, digite a ideia do seu livro para continuar.");
                }
            }
        }

        function parseContentToHtml(markdownText) {
            // Converte Markdown b√°sico em HTML para exibi√ß√£o e PDF
            let html = markdownText.replace(/\n/g, '<br>');
            html = html.replace(/<br>##\s*([^<]*)<br>/g, '<h2>$1</h2>');
            html = html.replace(/<br>#\s*([^<]*)<br>/g, '<h1>$1</h1>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
            html = html.replace(/\[IMAGEM\]/g, '<div style="text-align: center; margin: 20px 0; padding: 15px; border: 1px dashed #999; font-style: italic;">[ILUSTRA√á√ÉO N√ÉO INCLU√çDA - APENAS TEXTO]</div>');
            return html;
        }


        // --- Fun√ß√µes do Modal ---

        function openEditor() {
            document.getElementById('capa-prompt-display').innerText = lastGeneratedCapaPrompt;
            document.getElementById('book-content-editor').value = lastGeneratedBookContent;
            document.getElementById('editorModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editorModal').style.display = 'none';
        }


        // --- Fluxo Principal de Gera√ß√£o ---

        /**
         * Etapa 1: Chama a API e abre o modal de edi√ß√£o.
         */
        async function callGeminiAndOpenEditor() {
            const generateBtn = document.getElementById('generate-button');
            const loadingMsg = document.getElementById('loading-message');
            
            generateBtn.disabled = true;
            generateBtn.innerText = "Conectando √† API...";
            loadingMsg.style.display = 'block';
            document.getElementById('download-link').style.display = 'none';

            const title = document.getElementById('title-input').value;
            const author = document.getElementById('author-input').value || "Autor Desconhecido";
            const pages = document.getElementById('pages-select').value;
            const genre = document.getElementById('genre-input').value;
            const synopsis = document.getElementById('synopsis-text').value;

            // Prompt refor√ßado para conte√∫do humanizado e com formato espec√≠fico
            const full_prompt = `
                Aja como um escritor e designer de ebooks altamente criativo, humano e profissional.
                Seu objetivo √© satisfazer todos os pedidos do usu√°rio, entregando um texto de alta qualidade.
                Gere o conte√∫do COMPLETO de um ebook de ${pages} p√°ginas.
                
                **FORMATO ESTRUTURAL OBRIGAT√ìRIO:**
                1. A primeira linha deve ser o prompt de imagem para a capa. Use o formato: [CAPA_PROMPT]: (descri√ß√£o).
                2. Use o separador "---" para dividir a capa do conte√∫do.
                3. O conte√∫do deve ser em **Markdown** (para subt√≠tulos e negrito) e usar marca√ß√µes **P√ÅGINA X:**.
                4. O t√≠tulo √© **${title}** e o autor **${author}**.
                5. O estilo da escrita deve ser **humanizado**, envolvente e estritamente ${genre}.

                **SINOPSE:** ${synopsis}

                **EXEMPLO DE IN√çCIO DA RESPOSTA:**

                [CAPA_PROMPT]: Uma ilustra√ß√£o detalhada no estilo √≥leo, mostrando...
                ---
                [CONTEUDO_INICIO]:
                P√ÅGINA 1: Introdu√ß√£o
                ## O Despertar da Intelig√™ncia...
                ...
                `;

            // Payload CORRIGIDO (Removido o campo "config" que causava o erro JSON)
            const aiPayload = {
                contents: [{ role: "user", parts: [{ text: full_prompt }] }],
            };
            
            try {
                generateBtn.innerText = "Gerando Conte√∫do...";

                // Chamada direta para a API Gemini (insegura, mas funcional localmente)
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(aiPayload)
                });

                if (!response.ok) {
                    const errorJson = await response.json(); 
                    const errorMessage = errorJson.error.message || `Erro desconhecido HTTP ${response.status}`;
                    throw new Error(`Erro na API Gemini: ${errorMessage}`);
                }

                const data = await response.json();
                
                const aiResponseText = data.candidates[0].content.parts[0].text;
                
                // Processar a Resposta
                const parts = aiResponseText.split('---').map(s => s.trim());
                if (parts.length < 2) {
                    throw new Error("Resposta da IA incompleta. Certifique-se de que o separador '---' foi gerado.");
                }
                
                lastGeneratedCapaPrompt = parts[0].replace('[CAPA_PROMPT]:', '').trim();
                lastGeneratedBookContent = parts[1].replace('[CONTEUDO_INICIO]:', '').replace(/\[CONTEUDO_FIM\]/g, '').trim();
                
                // Abre o editor para revis√£o
                generateBtn.innerText = "‚úÖ Rascunho Pronto. Edite Agora.";
                loadingMsg.style.display = 'none';
                openEditor();

            } catch (error) {
                console.error("Erro Cr√≠tico:", error);
                alert("Ocorreu um erro ao gerar o Ebook. Verifique o console (F12) para mais detalhes. Erro: " + error.message);
            } finally {
                generateBtn.disabled = false;
                loadingMsg.style.display = 'none';
            }
        }


        /**
         * Etapa 2: Gera o PDF a partir do conte√∫do editado no modal. (CORRIGIDA: Solu√ß√£o para erro de escala jsPDF)
         */
        async function generatePdfFromEditor() {
            const finalContentRaw = document.getElementById('book-content-editor').value;
            closeModal();
            
            const generateBtn = document.getElementById('generate-button');
            const loadingMsg = document.getElementById('loading-message');
            
            generateBtn.disabled = true;
            generateBtn.innerText = "Finalizando PDF...";
            loadingMsg.style.display = 'block';

            try {
                const title = document.getElementById('title-input').value;
                const author = document.getElementById('author-input').value || "Autor Desconhecido";
                const fontSize = document.getElementById('font-size-select').value;
                
                const bookContentHTML = parseContentToHtml(finalContentRaw);
                
                // 1. MONTAR O HTML PARA GERA√á√ÉO DO PDF
                const pdfContentArea = document.getElementById('pdf-content-area');
                pdfContentArea.innerHTML = `
                    <div class="cover-page">
                        <div class="cover-image">
                            <h1 style="font-size: 2.5em; margin-top: 50px;">${title}</h1>
                            <h2 style="font-size: 1.2em; margin-bottom: 50px;">Por ${author}</h2>
                        </div>
                        <p style="font-style: italic; max-width: 400px; padding: 10px; color: #ecf0f1;">
                            Este Ebook foi gerado pela IA. 
                            <br><br>Prompt da Capa Sugerido: ${lastGeneratedCapaPrompt.substring(0, 150)}...
                        </p>
                    </div>
                    
                    <div class="book-page" style="font-size: ${fontSize}pt;">
                        ${bookContentHTML}
                    </div>
                `;
                
                // 2. GERAR O PDF USANDO JSLIBRARIES
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4'); 

                const pagesToRender = pdfContentArea.querySelectorAll('.cover-page, .book-page');
                let promises = [];

                for (let i = 0; i < pagesToRender.length; i++) {
                    const page = pagesToRender[i];
                    promises.push(
                        html2canvas(page, { scale: 3 }).then(canvas => { 
                            const imgData = canvas.toDataURL('image/jpeg', 1.0);
                            
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            
                            // Corre√ß√£o para o erro 'Invalid argument passed to jsPDF.scale'
                            const canvasWidth = canvas.width;
                            const canvasHeight = canvas.height;

                            if (canvasWidth === 0) {
                                console.error("Canvas width is zero, skipping page.");
                                return;
                            }
                            
                            const pdfHeight = (canvasHeight * pdfWidth) / canvasWidth;

                            if (i > 0) {
                                pdf.addPage();
                            }
                            
                            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        })
                    );
                }

                await Promise.all(promises);

                // 3. Salva o PDF
                const finalFileName = `${title.replace(/ /g, '_')}_BookAI.pdf`;
                pdf.save(finalFileName);
                
                // 4. Exibe o link de download
                document.getElementById('download-link').style.display = 'block';
                document.getElementById('pdf-download').innerText = `‚úÖ PDF Gerado! Baixe Agora`;
                document.getElementById('pdf-download').href = '#'; 

            } catch (error) {
                console.error("Erro Cr√≠tico no PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Verifique o console (F12) para mais detalhes. Erro: " + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerText = "Gerar Rascunho e Visualizar Edi√ß√£o";
                loadingMsg.style.display = 'none';
                document.getElementById('pdf-content-area').innerHTML = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('prompt-input').focus();
        });
    </script>
</body>
</html>