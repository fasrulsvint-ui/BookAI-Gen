<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookAI - Seu Gerador de Ebooks</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* [IN√çCIO DO CSS] */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        #app-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header { display: flex; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #ddd; margin-bottom: 30px; }
        #logo { width: 50px; height: 50px; margin-right: 15px; border-radius: 5px; object-fit: cover; }
        h1 { color: #2c3e50; font-size: 1.8em; margin: 0; }
        #main-page { text-align: center; padding-top: 50px; }
        #main-page h2 { font-size: 2.5em; margin-bottom: 40px; color: #34495e; }
        #prompt-input { width: 80%; max-width: 600px; padding: 15px 20px; font-size: 1.2em; border: 2px solid #ccc; border-radius: 30px; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #prompt-input:focus { border-color: #3498db; box-shadow: 0 6px 10px rgba(52, 152, 219, 0.2); outline: none; }
        
        /* üö® CORRE√á√ÉO CSS: MANT√âM APENAS A COLUNA ESQUERDA E ADICIONAIS */
        #config-page { display: grid; grid-template-columns: 1fr; gap: 30px; } /* Mudado para 1 coluna */
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        
        /* Ajustado para abranger a largura total */
        #synopsis-box { grid-column: 1 / 2; } 
        #synopsis-text { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; resize: vertical; font-size: 1em; }
        
        /* Ajustado para abranger a largura total */
        #generate-button { grid-column: 1 / 2; padding: 15px 30px; background-color: #2ecc71; color: white; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; transition: background-color 0.3s; }
        #generate-button:hover { background-color: #27ae60; }
        
        #loading-message { grid-column: 1 / 2; text-align: center; font-size: 1.2em; color: #f39c12; margin-top: 20px; display: none; }
        #download-link { grid-column: 1 / 2; text-align: center; margin-top: 30px; display: none; }
        #download-link a { padding: 15px 30px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; font-size: 1.2em; display: inline-block; transition: background-color 0.3s; }
        #download-link a:hover { background-color: #2980b9; }
        #pdf-content-area { position: absolute; left: -9999px; width: 700px; padding: 50px; background-color: white; }
        .book-page { width: 700px; height: 990px; padding: 50px; box-sizing: border-box; font-size: 12pt; line-height: 1.6; page-break-after: always; }
        .cover-page { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 990px; background-color: #2c3e50; color: white; page-break-after: always; }
        .cover-image { width: 400px; height: 550px; margin-bottom: 30px; object-fit: cover; border: 5px solid #ecf0f1; background-color: #34495e; } /* Ajustado para fundo de capa */
        /* [FIM DO CSS] */
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <img id="logo" src="Logo.jpg" alt="Logo BookAI">
            <h1>BookAI</h1>
        </header>

        <div id="main-page" style="display: block;">
            <h2>O que voc√™ quer criar hoje? üìö‚ú®</h2>
            <input type="text" id="prompt-input" placeholder="Digite a ideia principal do seu livro (ex: Um detetive rob√¥ em um mundo dist√≥pico de 2077)..." onkeyup="checkEnter(event)">
        </div>

        <div id="config-page" style="display: none;">
            <div class="column-left">
                <h2>Detalhes e Formato do Ebook ‚úèÔ∏è</h2>
                <div class="input-group">
                    <label for="title-input">T√≠tulo do Livro:</label>
                    <input type="text" id="title-input" value="Meu Grande Ebook">
                </div>
                <div class="input-group">
                    <label for="author-input">Nome do Autor:</label>
                    <input type="text" id="author-input" placeholder="Seu Nome">
                </div>
                <div class="input-group">
                    <label for="pages-select">Quantidade de P√°ginas (Conte√∫do):</label>
                    <select id="pages-select">
                        <script>
                            for (let i = 1; i <= 20; i++) {
                                document.write(`<option value="${i}" ${i === 5 ? 'selected' : ''}>${i} p√°ginas</option>`);
                            }
                        </script>
                    </select>
                </div>
                <div class="input-group">
                    <label for="genre-input">G√™nero/Estilo (Opcional):</label>
                    <input type="text" id="genre-input" placeholder="Fic√ß√£o Cient√≠fica, Romance, etc.">
                </div>
                <div class="input-group">
                    <label for="font-size-select">Tamanho da Fonte:</label>
                    <select id="font-size-select">
                        <option value="10">Pequena (10pt)</option>
                        <option value="12" selected>Normal (12pt)</option>
                        <option value="14">Grande (14pt)</option>
                    </select>
                </div>
            </div>
            <div id="synopsis-box">
                <label for="synopsis-text">Sinopse do Livro (Edit√°vel):</label>
                <textarea id="synopsis-text"></textarea>
            </div>
            
            <button id="generate-button" onclick="generateEbook()">Gerar Ebook e Capa em PDF</button>
            <p id="loading-message">‚è≥ Chamando o Backend Render e o Gemini...</p>
            <div id="download-link">
                <a href="#" id="pdf-download" download="BookAI_Ebook.pdf">‚¨áÔ∏è Baixar Livro em PDF</a>
            </div>
        </div>
    </div>

    <div id="pdf-content-area">
        </div>


    <script>
        const BACKEND_URL = 'https://bookai-qgeh.onrender.com/'; 

        function goToConfig(synopsis) {
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('config-page').style.display = 'grid';
            document.getElementById('synopsis-text').value = synopsis;
            if (document.getElementById('title-input').value === 'Meu Grande Ebook' && synopsis.length > 0) {
                document.getElementById('title-input').value = 'O Livro de ' + synopsis.substring(0, 20) + '...';
            }
        }

        function checkEnter(event) {
            if (event.key === 'Enter') {
                const prompt = document.getElementById('prompt-input').value.trim();
                if (prompt) {
                    goToConfig(prompt);
                } else {
                    alert("Por favor, digite a ideia do seu livro para continuar.");
                }
            }
        }

        /**
         * Converte o Markdown/Texto do Gemini em HTML para o PDF.
         */
        function parseContentToHtml(markdownText) {
            // Garante que as novas linhas sejam <br>
            let html = markdownText.replace(/\n/g, '<br>');
            
            // Converte t√≠tulos (se houver marca√ß√£o Markdown)
            html = html.replace(/<br>##\s*([^<]*)<br>/g, '<h2>$1</h2>');
            html = html.replace(/<br>#\s*([^<]*)<br>/g, '<h1>$1</h1>');
            
            // Converte bold/negrito
            html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
            
            // Substitui a tag de imagem (simulada)
            html = html.replace(/\[IMAGEM\]/g, '<div style="text-align: center; margin: 20px 0; padding: 15px; border: 1px dashed #999; font-style: italic;">[ILUSTRA√á√ÉO N√ÉO INCLU√çDA - APENAS TEXTO]</div>');

            return html;
        }


        // ---------------------------------------------
        // FUN√á√ÉO PRINCIPAL DE GERA√á√ÉO E PDF (SIMPLIFICADA)
        // ---------------------------------------------
        async function generateEbook() {
            const generateBtn = document.getElementById('generate-button');
            const loadingMsg = document.getElementById('loading-message');
            const downloadLinkDiv = document.getElementById('download-link');

            // 1. Coleta e estado inicial
            generateBtn.disabled = true;
            generateBtn.innerText = "Conectando ao Servidor...";
            loadingMsg.style.display = 'block';
            downloadLinkDiv.style.display = 'none';

            const title = document.getElementById('title-input').value;
            const author = document.getElementById('author-input').value || "Autor Desconhecido";
            const pages = document.getElementById('pages-select').value;
            const genre = document.getElementById('genre-input').value;
            const synopsis = document.getElementById('synopsis-text').value;
            const fontSize = document.getElementById('font-size-select').value;

            const payload = { title, author, pages, genre, synopsis };

            let aiResponseText;
            
            try {
                // 2. CHAMADA AO BACKEND PYTHON (Render)
                generateBtn.innerText = "Chamando o Gemini (Texto)...";
                
                // REMOVIDA A L√ìGICA DE CHAMADA DA CAPA SEPARADA
                const response = await fetch(`${BACKEND_URL}generate_ebook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // TRATAMENTO DE ERROS HTTP (404, 500, etc.)
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || "Falha ao obter resposta do backend.");
                }
                
                aiResponseText = data.ai_response_text;

                // 3. Processar a Resposta do Gemini
                const parts = aiResponseText.split('---').map(s => s.trim());
                if (parts.length < 2) {
                    throw new Error("Resposta da IA incompleta. Certifique-se de que o separador '---' foi gerado.");
                }
                
                const capaPromptLine = parts[0].replace('[CAPA_PROMPT]:', '').trim();
                let bookContentRaw = parts[1].replace('[CONTEUDO_INICIO]:', '').replace(/\[CONTEUDO_FIM\]/g, '').trim();
                
                const bookContentHTML = parseContentToHtml(bookContentRaw);
                
                
                // 4. MONTAR O HTML PARA GERA√á√ÉO DO PDF (CAPA SIMPLES)
                const pdfContentArea = document.getElementById('pdf-content-area');
                pdfContentArea.innerHTML = `
                    <div class="cover-page">
                        <div class="cover-image">
                            <h1 style="font-size: 2.5em; margin-top: 50px;">${title}</h1>
                            <h2 style="font-size: 1.2em; margin-bottom: 50px;">Por ${author}</h2>
                        </div>
                        <p style="font-style: italic; max-width: 400px; padding: 10px; color: #ecf0f1;">
                            Este Ebook foi gerado pela IA. 
                            <br><br>Prompt da Capa Sugerido: ${capaPromptLine.substring(0, 150)}...
                        </p>
                    </div>
                    
                    <div class="book-page" style="font-size: ${fontSize}pt;">
                        ${bookContentHTML}
                    </div>
                `;
                
                // 5. GERAR O PDF USANDO JSLIBRARIES
                generateBtn.innerText = "Finalizando PDF...";
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4'); 

                const pagesToRender = pdfContentArea.querySelectorAll('.cover-page, .book-page');
                let promises = [];

                for (let i = 0; i < pagesToRender.length; i++) {
                    const page = pagesToRender[i];
                    promises.push(
                        html2canvas(page, { scale: 3 }).then(canvas => { 
                            const imgData = canvas.toDataURL('image/jpeg', 1.0);
                            const imgProps= pdf.getImageProperties(imgData);
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                            if (i > 0) {
                                pdf.addPage();
                            }
                            
                            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        })
                    );
                }

                await Promise.all(promises);

                // 6. Salva o PDF
                const finalFileName = `${title.replace(/ /g, '_')}_BookAI.pdf`;
                pdf.save(finalFileName);
                
                // 7. Exibe o link de download
                downloadLinkDiv.style.display = 'block';
                document.getElementById('pdf-download').innerText = `‚úÖ PDF Gerado! Baixe Agora`;
                document.getElementById('pdf-download').href = '#'; 

            } catch (error) {
                console.error("Erro Cr√≠tico:", error);
                alert("Ocorreu um erro ao gerar o Ebook. Verifique o console para mais detalhes. Erro: " + error.message);
            } finally {
                // 8. Restaurar o bot√£o
                generateBtn.disabled = false;
                generateBtn.innerText = "Gerar Ebook e Capa em PDF";
                loadingMsg.style.display = 'none';
                document.getElementById('pdf-content-area').innerHTML = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('prompt-input').focus();
        });
    </script>
</body>
</html>